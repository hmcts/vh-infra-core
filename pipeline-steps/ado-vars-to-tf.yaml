parameters:
  - name: environment
    type: string

steps:
  - powershell: |
     
      $env = "${{ parameters.environment }}"

      $ba_obj=$($env:bookings_secrets) | ConvertFrom-Json
      Write-Host $ba_obj
      $bookings_secrets = @{
        "key_vault_name" = "vh-bookings-api- $env"
        "secrets"        = $ba_obj + $($env:bookings_secrets_v2 | ConvertFrom-Json)
      }
      $notifications_secrets = @{
        "key_vault_name" = "vh-notifications-api- $env"
        "secrets"        = $($env:notifications_secrets | ConvertFrom-Json)
      }

      $all_secrets = @($bookings_secrets, $notifications_secrets)
      Write-Host("##vso[task.setvariable variable=ado_vars;isOutput=true]$all_secrets");
    env:
      bookings_secrets: $(vh-bookings-api-secrets)
      bookings_secrets_v2: $(vh-bookings-api-v2-secrets)
      notifications_secrets: $(vh-notifications-api-secrets)
    displayName: "Get Secrets from ADO Library to tf vars"
    name: ado_vars_to_json