parameters:
  - name: environment
    type: string

steps:
  - powershell: |
      $env = "${{ parameters.environment }}"
      $all_secrets = @()

      $ba_obj = Get-Content .\vh-bookings-api-secrets.json | ConvertFrom-Json
      $secrets_obj = $ba_obj
      if ($null -ne $secrets_obj) {
          $bookings_secrets = [pscustomobject]@{
              "key_vault_name" = "vh-bookings-api"
              "secrets"        = $secrets_obj
          }
          $all_secrets += $bookings_secrets
      }

      $all_secrets = $all_secrets | ConvertTo-Json  -Compress -Depth 100
      $all_secrets = $all_secrets -replace "`"", "\`""
      Write-Host $all_secrets 
      Write-Host("##vso[task.setvariable variable=ado_vars;isOutput=true]$all_secrets");
    displayName: "Get Secrets from ADO Library to tf vars"
    name: ado_vars_to_tf
    workingDirectory: $(System.DefaultWorkingDirectory)/vh-setup/keyvault-mapping