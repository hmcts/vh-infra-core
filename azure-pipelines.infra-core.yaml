resources:
  repositories:
    - repository: templates
      type: github
      name: hmcts/azure-devops-templates
      ref: refs/heads/VIH-9097-sql-access
      endpoint: hmcts

pr: 
  - master

trigger:
  branches:
    include:
    - master
  paths:
    include:
    - terraform/09-video-hearing-core

parameters:
  - name: environment
    type: object
    default:
    - Dev
    - Demo
    - Stg
    - Prod
  - name: dbAccess
    type: object
    default:
      - user: vh-wowza-dev-1
        databaseName: vhbookings
        roles:
          - db_datareader
      - user: dcd_videohearings
        databaseName: vhbookings
        roles:
          - db_datareader

pool:
  vmImage: 'ubuntu-latest'

variables:
- name: tfVersion
  value: 1.2.0
- group: external
- name: azureLocation
  value: 'UK South'
stages:

################################################
# Validate Infra Code. #########################

- stage: Validate_Terraform_Code
  displayName: 'Validate Terraform Code'
  jobs:
    - job: Validate_Terraform_Code
      displayName: Validate Terraform Code
      steps:
        - template: pipeline-steps/terraform-validate.yaml
          parameters:
            tfversion: ${{ variables.tfversion }}
            stack: '09-video-hearing-core'


################################################
# Terraform Plan & Apply. ######################

- ${{ each env in parameters.environment }}:
  - template: pipeline-steps/terraform-plan-apply.yaml
    parameters:
      terraformVersion: ${{ variables.tfVersion }}
      env: ${{ env }}
      location: ${{ variables.azureLocation }}
      environmentServiceConnection: DTS-SHAREDSERVICES-${{ env }}-Video Hearings
      stack: 09-video-hearing-core
      product: vh
      activityName: Video_Hearing_Core
      tfStateResourceGroup: vh-infra-core-${{ env }}-tf
      tfStateStorageAccountName: vhinfracore${{ env }}tf
  
  - template: pipeline-steps/sql-access.yaml
    parameters:
      azureSubscription: DTS-SHAREDSERVICES-${{ env }}-Video Hearings
      sqlServerResourceGroup: vh-infra-core-${{ env }}
      sqlServerName: vh-infra-core-${{ env }}
      dbAccess:
        - user: 'DTS SDS Developers'
          databaseNames: 
            - vhbookings
            - vhnotification
            - vhvideo
          roles:
            - db_datareader
            - db_datawriter
        - user: mi-ingestion-adf-${{ env }}
          databaseNames: 
            - vhbookings
          roles:
            - db_datareader