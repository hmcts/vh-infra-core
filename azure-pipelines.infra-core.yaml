resources:
  repositories:
    - repository: templates
      type: github
      name: hmcts/azure-devops-templates
      ref: refs/heads/master
      endpoint: hmcts

trigger:
  - none

parameters:
- name: environment
  type: object
  default:
   - Dev
   - Demo

pool:
  vmImage: 'ubuntu-latest'

variables:
- name: tfVersion
  value: 1.1.0
- group: external
- name: azureLocation
  value: 'UK South'
stages:


################################################
# Terraform Plan & Apply. ######################

- ${{ each env in parameters.environment }}:
  - template: pipeline-steps/terraform-plan-apply.yaml
    parameters:
      terraformVersion: ${{ variables.tfVersion }}
      env: ${{ env }}
      location: ${{ variables.azureLocation }}
      environmentServiceConnection: DTS-SHAREDSERVICES-${{ env }}-Video Hearings
      stack: 09-video-hearing-core
      product: vh
      activityName: Video_Hearing_Core
      tfStateResourceGroup: vh-infra-core-{{env}}-tf
      tfStateStorageAccountName: vhinfracore{{env}}tf